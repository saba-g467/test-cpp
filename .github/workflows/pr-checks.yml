name: PR Checks

on:
  pull_request:
    branches:
      - main

jobs:
  lint:
    name: Lint
    uses: saba-g467/test-cpp-shared-actions/.github/workflows/cpp-lint.yml@main

  build-test:
    name: Build and Test
    uses: saba-g467/test-cpp-shared-actions/.github/workflows/cpp-build-test.yml@main
    with:
      source-dir: test/sample1/tether_sum

  version-suffix-preview:
    name: Build with Version Suffix (Preview)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Conan
        run: pip install conan

      - name: Configure Conan
        run: conan profile detect --force

      - name: Build with version suffix
        working-directory: test/sample1/tether_sum
        env:
          CONAN_VERSION_SUFFIX: dev-${{ github.sha }}
        run: |
          echo "Building package with version suffix: dev-${GITHUB_SHA::7}"
          mv conan.lock conan.lock.backup
          conan create . -o tether_sum:build_tests=True -o tether_sum:run_tests=True --build=missing
          mv conan.lock.backup conan.lock

  lock-check:
    name: Verify Conan Lock
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Conan
        run: pip install conan

      - name: Configure Conan
        run: conan profile detect --force

      - name: Verify conan.lock is up-to-date
        working-directory: test/sample1/tether_sum
        run: |
          # Generate fresh lock file
          conan lock create . --lockfile-out=conan.lock.new

          # Compare with existing lock file if it exists
          if [ -f conan.lock ]; then
            if ! diff -q conan.lock conan.lock.new > /dev/null 2>&1; then
              echo "::error::conan.lock is out of date. Please run 'conan lock create .' and commit the updated lock file."
              diff conan.lock conan.lock.new || true
              exit 1
            fi
            echo "conan.lock is up-to-date"
          else
            echo "::error::No conan.lock file found. Please run 'conan lock create .' and commit it."
            exit 1
          fi
