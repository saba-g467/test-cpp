name: Release

on:
  push:
    branches:
      - main

jobs:
  check-publish-label:
    runs-on: ubuntu-latest
    outputs:
      should_publish: ${{ steps.check_label.outputs.should_publish }}
      version: ${{ steps.read_version.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check if merged PR has publish label
        id: check_label
        uses: actions/github-script@v7
        with:
          script: |
            const { data: commits } = await github.rest.repos.listPullRequestsAssociatedWithCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha
            });

            if (commits.length === 0) {
              console.log('No PR associated with this commit');
              core.setOutput('should_publish', 'false');
              return;
            }

            const pr = commits[0];
            console.log(`Found PR #${pr.number}: ${pr.title}`);

            const hasPublishLabel = pr.labels.some(label => label.name === 'publish');
            console.log(`Has publish label: ${hasPublishLabel}`);

            core.setOutput('should_publish', hasPublishLabel ? 'true' : 'false');

      - name: Read version from VERSION file
        id: read_version
        if: steps.check_label.outputs.should_publish == 'true'
        run: |
          VERSION=$(cat test/sample1/tether_sum/VERSION | tr -d '[:space:]')
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Using version: ${VERSION}"

  build-release:
    needs: check-publish-label
    if: needs.check-publish-label.outputs.should_publish == 'true'
    uses: saba-g467/test-cpp-shared-actions/.github/workflows/conan-publish.yml@main
    with:
      source-dir: 'test/sample1/tether_sum'
      package-name: 'tether_sum'
      package-version: ${{ needs.check-publish-label.outputs.version }}
      remote-name: 'conan-stable'
      profile-dir: 'conan-profiles'
    secrets:
      github-token: ${{ secrets.GITHUB_TOKEN }}

  create-release:
    needs: [check-publish-label, build-release]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create git tag
        run: |
          VERSION="${{ needs.check-publish-label.outputs.version }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "v${VERSION}" -m "Release v${VERSION}"
          git push origin "v${VERSION}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate release notes
        id: release_notes
        run: |
          VERSION="${{ needs.check-publish-label.outputs.version }}"
          echo "## Release v${VERSION}" > release_notes.md
          echo "" >> release_notes.md
          echo "### Changes" >> release_notes.md
          echo "" >> release_notes.md
          git log --pretty=format:"- %s" $(git describe --tags --abbrev=0 2>/dev/null || git rev-list --max-parents=0 HEAD)..HEAD >> release_notes.md 2>/dev/null || echo "- Initial release" >> release_notes.md
          echo "" >> release_notes.md
          echo "### Package Information" >> release_notes.md
          echo "" >> release_notes.md
          echo "- **Package:** tether_sum/${VERSION}" >> release_notes.md
          echo "- **Remote:** conan-stable" >> release_notes.md
          echo "- **Platforms:** Linux, Windows, macOS" >> release_notes.md
          echo "" >> release_notes.md
          echo "### Installation" >> release_notes.md
          echo "" >> release_notes.md
          echo '```bash' >> release_notes.md
          echo "conan install --requires=tether_sum/${VERSION}" >> release_notes.md
          echo '```' >> release_notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.check-publish-label.outputs.version }}
          name: Release v${{ needs.check-publish-label.outputs.version }}
          body_path: release_notes.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
